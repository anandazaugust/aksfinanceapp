<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Finance Tracker</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h1>Finance Tracker</h1>

    <section class="summary">
      <h2>Summary</h2>
      <div id="summary">
        <span>Income: â€”</span>
        <span>Expense: â€”</span>
        <span>Balance: â€”</span>
      </div>
    </section>

    <!-- EXPENSE FORM -->
    <section class="add">
      <h2>Add Expense</h2>
      <form id="expense-form">
        <label>
          Date
          <input type="date" name="txDate" required />
        </label>
        <label>
          Category
          <input type="text" name="category" placeholder="Groceries / Rent" required />
        </label>
        <label>
          Note
          <input type="text" name="note" placeholder="Optional" />
        </label>
        <label>
          Amount
          <input type="number" name="amount" step="0.01" required />
        </label>
        <button type="submit">Add Expense</button>
      </form>
      <div id="expense-msg"></div>
    </section>

    <!-- INCOME FORM -->
    <section class="add">
      <h2>Add Income</h2>
      <form id="income-form">
        <label>
          Date
          <input type="date" name="txDate" required />
        </label>
        <label>
          Category
          <input type="text" name="category" placeholder="Salary / Bonus" required />
        </label>
        <label>
          Note
          <input type="text" name="note" placeholder="Optional" />
        </label>
        <label>
          Amount
          <input type="number" name="amount" step="0.01" required />
        </label>
        <button type="submit">Add Income</button>
      </form>
      <div id="income-msg"></div>
    </section>

    <section class="list">
      <h2>Recent Transactions</h2>
      <table>
        <thead>
          <tr><th>Date</th><th>Category</th><th>Note</th><th class="right">Amount</th></tr>
        </thead>
        <tbody id="tx-body">
          <tr><td colspan="4">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
    async function loadSummary() {
      const el = document.getElementById("summary");
      try {
        const r = await fetch("/api/summary");
        const s = await r.json();
        el.innerHTML = `
          <span>Income: <strong>${(+s.totalIncome || 0).toFixed(2)}</strong></span>
          <span>Expense: <strong>${(+s.totalExpense || 0).toFixed(2)}</strong></span>
          <span>Balance: <strong>${(+s.balance || 0).toFixed(2)}</strong></span>
        `;
      } catch {
        el.innerHTML = "<span class='error'>Failed to load summary</span>";
      }
    }

    async function loadTransactions() {
      const body = document.getElementById("tx-body");
      try {
        const r = await fetch("/api/transactions");
        const items = await r.json();
        if (!Array.isArray(items)) throw new Error("Bad payload");
        body.innerHTML = items.map(tx => `
          <tr>
            <td>${new Date(tx.TxDate || tx.txDate).toISOString().slice(0,10)}</td>
            <td>${tx.Category ?? ""}</td>
            <td>${tx.Note ?? ""}</td>
            <td class="right ${tx.Amount < 0 ? "neg" : "pos"}">${(+tx.Amount).toFixed(2)}</td>
          </tr>
        `).join("");
      } catch {
        body.innerHTML = `<tr><td colspan="4" class="error">Failed to load transactions</td></tr>`;
      }
    }

    async function submitForm(formId, msgId, type) {
      const form = document.getElementById(formId);
      const msg = document.getElementById(msgId);

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form).entries());
        data.amount = parseFloat(data.amount);
        data.type = type; // ðŸ‘ˆ force type (expense/income)

        try {
          const r = await fetch("/api/transactions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });
          const payload = await r.json();
          if (!r.ok) throw new Error(payload.error || "Failed");
          msg.textContent = "Saved!";
          msg.className = "success";
          form.reset();
          form.querySelector("input[name=txDate]").value = new Date().toISOString().split("T")[0];
          await Promise.all([loadSummary(), loadTransactions()]);
        } catch (err) {
          msg.textContent = err.message || "Failed to save";
          msg.className = "error";
        }
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // set default date to today
      document.querySelectorAll("input[name=txDate]").forEach(el => {
        el.value = new Date().toISOString().split("T")[0];
      });

      await Promise.all([loadSummary(), loadTransactions()]);
      submitForm("expense-form", "expense-msg", "expense");
      submitForm("income-form", "income-msg", "income");
    });
  </script>
</body>
</html>
